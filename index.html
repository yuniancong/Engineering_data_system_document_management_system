<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工程资料归档管理系统 - GB 50328-2014</title>
    <link rel="stylesheet" href="styles.css">
    <!-- SheetJS库用于Excel导出 -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- JSZip库用于处理docx文件 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!--  docxtemplater库用于Word模板处理 -->
    <script src="https://unpkg.com/docxtemplater@3.42.3/build/docxtemplater.js"></script>
    <!-- FileSaver用于文件下载 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>工程资料归档管理系统</h1>
            <p class="subtitle">基于 GB 50328-2014《建设工程文件归档规范》</p>
        </header>

        <nav class="tabs">
            <button class="tab-btn active" data-tab="volumes">案卷管理</button>
            <button class="tab-btn" data-tab="directory">卷内目录</button>
            <button class="tab-btn" data-tab="record">卷内备考表</button>
            <button class="tab-btn" data-tab="cover">案卷封面</button>
            <button class="tab-btn" data-tab="catalog">案卷目录</button>
            <button class="tab-btn" data-tab="transfer">档案移交书</button>
        </nav>

        <!-- 案卷管理 -->
        <div id="volumes" class="tab-content active">
            <div class="section-header">
                <h2>案卷管理</h2>
                <div class="toolbar">
                    <button id="createVolumeBtn" class="btn btn-success">+ 新建案卷</button>
                    <button id="generateAllBtn" class="btn btn-primary">生成汇总数据</button>
                </div>
            </div>

            <!-- 工程信息 -->
            <div class="form-section">
                <h3>工程信息</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>工程名称：</label>
                        <input type="text" id="projectName" placeholder="请输入工程名称">
                    </div>
                    <div class="form-group">
                        <label>编制单位：</label>
                        <input type="text" id="projectUnit" placeholder="请输入编制单位">
                    </div>
                    <div class="form-group">
                        <label>密级：</label>
                        <select id="projectSecretLevel">
                            <option value="">无</option>
                            <option value="秘密">秘密</option>
                            <option value="机密">机密</option>
                            <option value="绝密">绝密</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>保管期限：</label>
                        <select id="projectRetentionPeriod">
                            <option value="永久" selected>永久</option>
                            <option value="长期">长期</option>
                            <option value="短期">短期</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 案卷列表 -->
            <div class="form-section">
                <h3>案卷列表（共 <span id="volumeCount">0</span> 卷）</h3>
                <div id="volumesList" class="volumes-list">
                    <div class="empty-state">
                        <p>暂无案卷，请点击"新建案卷"创建</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 卷内目录 -->
        <div id="directory" class="tab-content">
            <div class="section-header">
                <h2>卷内目录</h2>
                <div class="toolbar">
                    <button id="addRowBtn" class="btn btn-primary">添加行</button>
                    <button id="deleteRowBtn" class="btn btn-danger">删除选中行</button>
                    <button id="autoGenerateBtn" class="btn btn-success">自动生成其他表格</button>
                    <button id="pasteRowBtn" class="btn btn-warning">📋 粘贴整行</button>
                    <button id="pasteRowCustomBtn" class="btn btn-warning">📋 自定义粘贴</button>
                    <label class="mode-switch">
                        <input type="checkbox" id="clipboardModeToggle">
                        <span>启用列粘贴模式</span>
                    </label>
                </div>
            </div>

            <!-- 自定义粘贴对话框 -->
            <div id="pasteCustomDialog" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>自定义粘贴 - 列映射设置</h3>
                        <button class="modal-close" id="closeCustomDialog">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p class="hint">请选择剪贴板中的每一列对应系统中的哪个字段：</p>
                        <div id="columnMappingContainer">
                            <div class="mapping-row">
                                <label>剪贴板第1列 →</label>
                                <select class="column-select" data-index="0">
                                    <option value="">不导入</option>
                                    <option value="fileNumber">文件编号</option>
                                    <option value="responsible">责任者</option>
                                    <option value="title" selected>文件题名</option>
                                    <option value="date">日期</option>
                                    <option value="pages">页次</option>
                                    <option value="remark">备注</option>
                                </select>
                            </div>
                            <div class="mapping-row">
                                <label>剪贴板第2列 →</label>
                                <select class="column-select" data-index="1">
                                    <option value="">不导入</option>
                                    <option value="fileNumber">文件编号</option>
                                    <option value="responsible">责任者</option>
                                    <option value="title">文件题名</option>
                                    <option value="date">日期</option>
                                    <option value="pages">页次</option>
                                    <option value="remark">备注</option>
                                </select>
                            </div>
                            <div class="mapping-row">
                                <label>剪贴板第3列 →</label>
                                <select class="column-select" data-index="2">
                                    <option value="">不导入</option>
                                    <option value="fileNumber">文件编号</option>
                                    <option value="responsible">责任者</option>
                                    <option value="title">文件题名</option>
                                    <option value="date">日期</option>
                                    <option value="pages">页次</option>
                                    <option value="remark">备注</option>
                                </select>
                            </div>
                            <div class="mapping-row">
                                <label>剪贴板第4列 →</label>
                                <select class="column-select" data-index="3">
                                    <option value="">不导入</option>
                                    <option value="fileNumber">文件编号</option>
                                    <option value="responsible">责任者</option>
                                    <option value="title">文件题名</option>
                                    <option value="date">日期</option>
                                    <option value="pages">页次</option>
                                    <option value="remark">备注</option>
                                </select>
                            </div>
                            <div class="mapping-row">
                                <label>剪贴板第5列 →</label>
                                <select class="column-select" data-index="4">
                                    <option value="">不导入</option>
                                    <option value="fileNumber">文件编号</option>
                                    <option value="responsible">责任者</option>
                                    <option value="title">文件题名</option>
                                    <option value="date">日期</option>
                                    <option value="pages">页次</option>
                                    <option value="remark">备注</option>
                                </select>
                            </div>
                            <div class="mapping-row">
                                <label>剪贴板第6列 →</label>
                                <select class="column-select" data-index="5">
                                    <option value="">不导入</option>
                                    <option value="fileNumber">文件编号</option>
                                    <option value="responsible">责任者</option>
                                    <option value="title">文件题名</option>
                                    <option value="date">日期</option>
                                    <option value="pages">页次</option>
                                    <option value="remark">备注</option>
                                </select>
                            </div>
                        </div>
                        <div class="preset-buttons">
                            <button class="btn btn-secondary btn-sm" id="presetDefault">预设：默认顺序</button>
                            <button class="btn btn-secondary btn-sm" id="presetTitleOnly">预设：仅题名</button>
                            <button class="btn btn-secondary btn-sm" id="presetTitleDate">预设：题名+日期</button>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" id="cancelCustomPaste">取消</button>
                        <button class="btn btn-primary" id="confirmCustomPaste">确定粘贴</button>
                    </div>
                </div>
            </div>

            <!-- 列粘贴按钮（紧贴表格上方） -->
            <div id="clipboardButtons" class="clipboard-buttons-inline" style="display: none;">
                <div class="clipboard-hint">点击列按钮，将剪贴板内容粘贴到该列：</div>
                <button class="clipboard-btn-small" data-column="fileNumber">文件编号</button>
                <button class="clipboard-btn-small" data-column="responsible">责任者</button>
                <button class="clipboard-btn-small" data-column="title">文件题名</button>
                <button class="clipboard-btn-small" data-column="date">日期</button>
                <button class="clipboard-btn-small" data-column="pages">页次</button>
                <button class="clipboard-btn-small" data-column="remark">备注</button>
            </div>

            <div class="table-wrapper">
                <table id="directoryTable" class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">
                                <input type="checkbox" id="selectAll">
                            </th>
                            <th style="width: 60px;">序号</th>
                            <th style="width: 120px;">文件编号</th>
                            <th style="width: 120px;">责任者</th>
                            <th style="width: 300px;">文件题名</th>
                            <th style="width: 120px;">日期</th>
                            <th style="width: 100px;">页次</th>
                            <th style="width: 150px;">备注</th>
                        </tr>
                    </thead>
                    <tbody id="directoryTableBody">
                        <!-- 动态生成的行 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 卷内备考表 -->
        <div id="record" class="tab-content">
            <div class="section-header">
                <h2>卷内备考表</h2>
                <div class="toolbar">
                    <button id="syncRecordBtn" class="btn btn-warning">从卷内目录同步</button>
                </div>
            </div>

            <div class="record-form">
                <div class="form-group">
                    <label>本案卷共有文件材料</label>
                    <input type="number" id="totalPages" readonly> 页，其中：
                </div>
                <div class="form-group">
                    <label>文字材料</label>
                    <input type="number" id="textPages"> 页，
                    <label>图样材料</label>
                    <input type="number" id="drawingPages"> 页，
                </div>
                <div class="form-group">
                    <label>照片</label>
                    <input type="number" id="photoCount"> 张。
                </div>
                <div class="form-group">
                    <label>说明：</label>
                    <textarea id="recordNote" rows="5"></textarea>
                </div>
                <div class="signature-section">
                    <div class="signature-item">
                        <label>立卷人：</label>
                        <input type="text" id="recordCreator">
                        <input type="date" id="recordCreateDate">
                    </div>
                    <div class="signature-item">
                        <label>审核人：</label>
                        <input type="text" id="recordReviewer">
                        <input type="date" id="recordReviewDate">
                    </div>
                </div>
            </div>
        </div>

        <!-- 案卷封面 -->
        <div id="cover" class="tab-content">
            <div class="section-header">
                <h2>案卷封面</h2>
                <div class="toolbar">
                    <button id="syncCoverBtn" class="btn btn-warning">从卷内目录同步</button>
                </div>
            </div>

            <div class="cover-form">
                <div class="form-group">
                    <label>档号：</label>
                    <input type="text" id="coverArchiveNo" placeholder="由档案保管单位统一编制">
                </div>
                <div class="form-group">
                    <label>案卷题名：</label>
                    <textarea id="coverTitle" rows="3" placeholder="工程名称 + 专业/分部工程 + 资料类别"></textarea>
                </div>
                <div class="form-group">
                    <label>编制单位：</label>
                    <input type="text" id="coverUnit">
                </div>
                <div class="form-group">
                    <label>起止日期：</label>
                    <input type="text" id="coverStartDate" placeholder="YYYY-MM-DD">
                    至
                    <input type="text" id="coverEndDate" placeholder="YYYY-MM-DD">
                </div>
                <div class="form-group">
                    <label>密级：</label>
                    <select id="coverSecretLevel">
                        <option value="">无</option>
                        <option value="秘密">秘密</option>
                        <option value="机密">机密</option>
                        <option value="绝密">绝密</option>
                    </select>
                    <label style="margin-left: 20px;">保管期限：</label>
                    <select id="coverRetentionPeriod">
                        <option value="永久">永久</option>
                        <option value="长期">长期</option>
                        <option value="短期">短期</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>本工程共</label>
                    <input type="number" id="coverTotalVolumes" style="width: 80px;"> 卷
                    <label style="margin-left: 20px;">本案卷为第</label>
                    <input type="number" id="coverVolumeNumber" style="width: 80px;"> 卷
                </div>
            </div>
        </div>

        <!-- 案卷目录 -->
        <div id="catalog" class="tab-content">
            <div class="section-header">
                <h2>案卷目录</h2>
                <div class="toolbar">
                    <button id="addCatalogBtn" class="btn btn-primary">添加案卷</button>
                    <button id="syncCatalogBtn" class="btn btn-warning">从当前卷同步</button>
                </div>
            </div>

            <div class="table-wrapper">
                <table id="catalogTable" class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 80px;">案卷号</th>
                            <th style="width: 250px;">案卷题名</th>
                            <th colspan="3" style="width: 200px;">卷内数量</th>
                            <th style="width: 150px;">编制单位</th>
                            <th style="width: 120px;">编制日期</th>
                            <th style="width: 100px;">保管期限</th>
                            <th style="width: 80px;">密级</th>
                            <th style="width: 100px;">备注</th>
                        </tr>
                        <tr class="sub-header">
                            <th></th>
                            <th></th>
                            <th>文字(页)</th>
                            <th>图纸(张)</th>
                            <th>其他</th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="catalogTableBody">
                        <!-- 动态生成的行 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 档案移交书 -->
        <div id="transfer" class="tab-content">
            <div class="section-header">
                <h2>档案移交书</h2>
                <div class="toolbar">
                    <button id="syncTransferBtn" class="btn btn-success">刷新统计数据</button>
                </div>
            </div>

            <!-- 汇总统计 -->
            <div class="form-section">
                <h3>汇总统计（自动计算）</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <label>案卷数量：</label>
                        <span id="transferTotalVolumes" class="stat-value">0</span> 卷
                    </div>
                    <div class="stat-item">
                        <label>文件总数：</label>
                        <span id="transferTotalFiles" class="stat-value">0</span> 份
                    </div>
                    <div class="stat-item">
                        <label>文件总页数：</label>
                        <span id="transferTotalPages" class="stat-value">0</span> 页
                    </div>
                </div>

                <h4>材料分类统计</h4>
                <div class="stats-grid">
                    <div class="stat-item">
                        <label>文字材料：</label>
                        <span id="transferTextVolumes" class="stat-value">0</span> 卷 /
                        <span id="transferTextPages" class="stat-value">0</span> 页
                    </div>
                    <div class="stat-item">
                        <label>图样材料：</label>
                        <span id="transferDrawingVolumes" class="stat-value">0</span> 卷 /
                        <span id="transferDrawingPages" class="stat-value">0</span> 张
                    </div>
                    <div class="stat-item">
                        <label>照片：</label>
                        <span id="transferPhotoCount" class="stat-value">0</span> 张
                    </div>
                </div>
            </div>

            <!-- 移交信息 -->
            <div class="form-section">
                <h3>移交信息</h3>
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label>移交说明：</label>
                        <textarea id="transferNote" rows="3" placeholder="请输入移交说明">本工程档案资料已按GB 50328-2014标准整理完毕，现移交存档。</textarea>
                    </div>
                    <div class="form-group">
                        <label>移交人：</label>
                        <input type="text" id="transferPerson" placeholder="请输入移交人姓名">
                    </div>
                    <div class="form-group">
                        <label>移交日期：</label>
                        <input type="date" id="transferDate">
                    </div>
                    <div class="form-group">
                        <label>接收人：</label>
                        <input type="text" id="receivePerson" placeholder="请输入接收人姓名">
                    </div>
                    <div class="form-group">
                        <label>接收日期：</label>
                        <input type="date" id="receiveDate">
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>符合 GB 50328-2014《建设工程文件归档规范》标准</p>
            <div class="data-actions">
                <button id="saveDataBtn" class="btn btn-primary">保存数据</button>
                <button id="loadDataBtn" class="btn btn-secondary">加载数据</button>
                <button id="exportDataBtn" class="btn btn-success">导出Excel</button>
                <button id="exportWordBtn" class="btn btn-success">导出Word</button>
                <button id="clearDataBtn" class="btn btn-danger">清空所有数据</button>
            </div>
        </footer>
    </div>

    <!-- 新建案卷对话框 -->
    <div id="createVolumeDialog" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>新建案卷</h3>
                <button class="modal-close" id="closeCreateVolumeDialog">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>案卷题名：</label>
                    <input type="text" id="newVolumeTitle" placeholder="请输入案卷题名，如：设计文件卷" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div class="hint">
                    <p>提示：案卷创建后，可以在"卷内目录"中填写数据，系统会自动生成备考表和封面。</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelCreateVolume">取消</button>
                <button class="btn btn-success" id="confirmCreateVolume">创建</button>
            </div>
        </div>
    </div>

    <!-- Word导出选择对话框 -->
    <div id="wordExportDialog" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>选择要导出的Word文档</h3>
                <button class="modal-close" id="closeWordExportDialog">&times;</button>
            </div>
            <div class="modal-body">
                <p class="hint">请选择要导出的文档类型：</p>
                <div class="export-options">
                    <button class="btn btn-primary export-option-btn" data-template="directory">
                        📄 卷内目录
                    </button>
                    <button class="btn btn-primary export-option-btn" data-template="record">
                        📋 卷内备考表
                    </button>
                    <button class="btn btn-primary export-option-btn" data-template="cover">
                        📕 案卷封面
                    </button>
                    <button class="btn btn-primary export-option-btn" data-template="catalog">
                        📚 案卷目录
                    </button>
                    <button class="btn btn-primary export-option-btn" data-template="transfer">
                        📮 档案移交书
                    </button>
                    <button class="btn btn-success export-option-btn" data-template="all">
                        📦 导出全部文档
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelWordExport">取消</button>
            </div>
        </div>
    </div>

    <script src="data-manager.js"></script>
    <script src="volume-manager.js"></script>
    <script src="word-exporter.js"></script>
    <script src="volume-ui.js"></script>
    <script src="app.js"></script>
    <script src="debug-helper.js"></script>
</body>
</html>
