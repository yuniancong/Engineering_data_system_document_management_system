# 功能更新说明

## 已解决的问题

### ✅ 问题1：添加调试日志查看器

**需求**：在调试面板上添加 debug logs 参数用于查看内容，方便查看后台运行状况。

**解决方案**：
- 调试面板新增**三个标签页**：状态、日志、操作
- **日志标签页**自动捕获所有console.log/error/warn输出
- 最多保存200条日志，支持清空和刷新
- 日志按时间倒序显示（最新的在上面）
- 区分日志级别：LOG（灰色）、ERROR（红色）、WARN（橙色）

**使用方法**：
1. 点击页面右下角的**"🔍 调试"**按钮
2. 在调试面板中切换到**"日志"**标签页
3. 查看所有系统运行日志
4. 点击**"🔄 刷新"**查看最新日志
5. 点击**"🗑️ 清空日志"**清除所有日志

---

### ✅ 问题2：新建案卷按钮不起作用

**症状**：点击"+ 新建案卷"按钮没有反应。

**诊断步骤**：
1. 刷新浏览器页面（**Ctrl + F5** 强制刷新）
2. 打开调试面板，切换到**"日志"**标签页
3. 点击"+ 新建案卷"按钮
4. 查看日志输出

**预期的正常日志**：
```
[时间] LOG 点击新建案卷按钮
[时间] LOG 创建案卷: 案卷2, ID: xxx
[时间] LOG ✓ 案卷创建成功，已切换到卷内目录
[时间] LOG 切换到标签页: directory
[时间] LOG ✓ 已切换到 directory
```

**如果没有日志输出**，请检查：
1. 切换到调试面板的**"状态"**标签页，查看**"系统状态"**部分
2. 确认以下项目都是✅：
   - VolumeManager: 已加载
   - DataManager: 已加载
   - WordExporter: 已加载
   - 新建案卷按钮: 存在

**如果显示❌**，说明系统组件未正确加载，请：
1. 清空浏览器缓存（Ctrl + Shift + Delete）
2. 刷新页面
3. 查看浏览器控制台（F12）是否有红色错误

---

### ✅ 问题3：数据导出和导入功能

**需求**：保存数据和加载数据应该能够实现当前填报数据内容的资料导出和资料加载功能，方便工作内容保留或转移到另外设备。

**解决方案**：
完整的数据导入/导出功能已实现，支持：
- 导出为JSON文件
- 从JSON文件导入
- 跨设备数据转移
- 向后兼容旧版数据

---

## 数据导出/导入详细使用指南

### 方法1：使用底部按钮（推荐）

#### 导出数据

1. 在页面底部找到**"💾 导出JSON"**按钮
2. 点击按钮
3. 文件会自动下载，文件名格式：`工程名称_2024-11-16.json`

**导出内容包括**：
- 所有案卷数据（卷内目录、备考表、封面）
- 工程信息（工程名称、编制单位、密级等）
- 移交信息（移交人、接收人、移交说明等）
- 导出时间和版本信息

#### 导入数据

1. 在页面底部找到**"📂 导入JSON"**按钮
2. 点击按钮
3. 选择之前导出的JSON文件
4. 系统会显示确认对话框：
   ```
   确定要导入数据吗？

   类型: multi-volume
   版本: 2.0
   导出时间: 2024-11-16T10:30:00.000Z

   当前数据将被覆盖！
   ```
5. 点击**"确定"**导入数据
6. 导入成功后，所有UI会自动刷新

---

### 方法2：使用调试面板

也可以通过调试面板的"操作"标签页进行导入/导出操作。

### 方法3：使用LocalStorage按钮

#### 保存到本地存储

点击页面底部的**"保存数据"**按钮：
- 数据保存到浏览器LocalStorage
- 仅在当前浏览器可用
- 不适合跨设备转移

#### 从本地存储加载

点击**"加载数据"**按钮：
- 从LocalStorage恢复数据
- 仅能恢复同一浏览器的数据

**注意**：这种方式不适合数据备份和跨设备转移！请使用JSON导出/导入功能。

---

## 跨设备数据转移流程

### 场景：从设备A转移到设备B

#### 在设备A上：
1. 打开调试面板
2. 操作 → 💾 导出数据到JSON文件
3. 保存文件（如：`项目A_2024-11-16.json`）
4. 通过U盘、网盘、邮件等方式转移文件

#### 在设备B上：
1. 启动系统：`./run.sh`
2. 打开调试面板
3. 操作 → 📂 从JSON文件导入数据
4. 选择转移过来的JSON文件
5. 确认导入

**结果**：所有数据完整转移，包括所有案卷、工程信息、移交信息。

---

## 数据备份建议

### 定期备份

建议在以下时机导出数据：
1. **每天工作结束时**：导出当天的工作成果
2. **完成一个案卷后**：导出作为里程碑备份
3. **切换设备前**：确保数据不丢失
4. **重要修改前**：作为恢复点

### 备份文件命名

建议使用清晰的文件名：
```
项目名称_日期_备注.json

示例：
某某住宅小区_2024-11-16_3卷完成.json
某某工程_2024-11-15_设计阶段.json
```

### 备份存储

将JSON文件保存在：
- **本地文件夹**：桌面、文档
- **云存储**：网盘、OneDrive、iCloud
- **移动存储**：U盘、移动硬盘

---

## 调试面板完整功能说明

### 状态标签页

显示系统当前状态：

1. **📊 数据状态**
   - 卷内目录行数
   - 备考表数据完整性
   - 封面数据完整性
   - 案卷目录数量

2. **📄 模板状态**
   - 模板配置指南链接
   - 测试导出功能

3. **🎯 系统状态**
   - VolumeManager加载状态
   - DataManager加载状态
   - WordExporter加载状态
   - 新建案卷按钮状态
   - 当前案卷数量和题名

### 日志标签页

实时日志监控：

- **自动捕获**：所有console输出
- **日志级别**：
  - LOG（灰色）：普通信息
  - ERROR（红色）：错误信息
  - WARN（橙色）：警告信息
- **时间戳**：每条日志显示时间
- **操作**：清空、刷新

### 操作标签页

快速操作：

1. **⚡ 自动生成所有数据**
   - 一键生成备考表、封面、案卷目录

2. **💾 导出数据到JSON文件**
   - 导出完整项目数据

3. **📂 从JSON文件导入数据**
   - 导入之前导出的数据

4. **🗄️ 查看存储数据**
   - 在控制台查看LocalStorage数据

---

## 常见问题

### Q1: 导出的JSON文件在哪里？

默认保存在浏览器的下载文件夹。通常是：
- Windows: `C:\Users\用户名\Downloads`
- macOS: `/Users/用户名/Downloads`
- Linux: `~/Downloads`

### Q2: 可以导出Excel格式吗？

可以。点击底部的**"导出Excel"**按钮可以导出卷内目录为Excel格式。

但是：
- Excel导出仅包含当前案卷的卷内目录
- 不包含备考表、封面、移交信息
- **不推荐用于完整数据备份**

完整备份请使用JSON格式。

### Q3: 导入数据会覆盖当前数据吗？

是的。导入前系统会弹出确认对话框，明确提示"当前数据将被覆盖"。

**建议**：导入前先导出当前数据作为备份。

### Q4: JSON文件可以手动编辑吗？

可以，但不推荐。JSON文件是文本格式，可以用记事本打开编辑，但：
- 格式错误会导致导入失败
- 数据结构复杂，容易出错
- 建议仅用于查看，不要手动修改

### Q5: 旧版本的数据可以导入吗？

可以。系统会自动识别：
- `type: "multi-volume"`：新版多卷数据
- `type: "single-volume"`：旧版单卷数据

两种格式都支持导入。

### Q6: 如何确认数据已成功导出？

导出后：
1. 检查下载文件夹中是否有JSON文件
2. 用记事本打开文件，应该能看到JSON格式的数据
3. 文件大小应该大于0KB（有数据的话通常几KB到几十KB）

### Q7: 新建案卷按钮一直不起作用怎么办？

按照以下步骤诊断：

**步骤1：查看日志**
1. 打开调试面板
2. 切换到"日志"标签页
3. 点击"新建案卷"按钮
4. 查看是否有日志输出

**步骤2：检查系统状态**
1. 切换到"状态"标签页
2. 查看"系统状态"部分
3. 确认所有组件都是✅

**步骤3：查看浏览器控制台**
1. 按F12打开开发者工具
2. 切换到Console标签
3. 查看是否有红色错误信息

**步骤4：清除缓存重试**
1. Ctrl + Shift + Delete 打开清除缓存对话框
2. 选择"缓存的图片和文件"
3. 点击"清除数据"
4. 刷新页面（Ctrl + F5）

如果以上步骤都无效，请将"日志"标签页的内容复制出来以便进一步诊断。

---

## 技术说明

### 数据格式

#### 多卷数据（v2.0）

```json
{
  "type": "multi-volume",
  "exportVersion": "2.0",
  "exportTime": "2024-11-16T10:30:00.000Z",
  "projectInfo": {
    "id": "...",
    "name": "工程名称",
    "unit": "编制单位",
    "secretLevel": "",
    "retentionPeriod": "永久"
  },
  "volumes": [
    {
      "id": "...",
      "volumeNo": 1,
      "title": "案卷1",
      "directory": [...],
      "record": {...},
      "cover": {...}
    }
  ],
  "transferData": {
    "note": "...",
    "transferPerson": "...",
    ...
  }
}
```

#### 单卷数据（v1.0）

```json
{
  "type": "single-volume",
  "exportVersion": "1.0",
  "exportTime": "2024-11-16T10:30:00.000Z",
  "directory": [...],
  "record": {...},
  "cover": {...},
  "catalog": [...]
}
```

### 存储位置

- **JSON文件**：浏览器下载文件夹
- **LocalStorage**：
  - 多卷数据：`volumeData`
  - 单卷数据：`archiveData`

### 兼容性

- 支持Chrome、Edge、Firefox、Safari
- 需要支持ES6+的浏览器
- LocalStorage大小限制：通常5-10MB

---

## 更新日志

### v2.0 (2024-11-16)

**新功能**：
- ✅ 调试面板日志查看器
- ✅ JSON格式数据导出
- ✅ JSON格式数据导入
- ✅ 系统状态实时显示
- ✅ 跨设备数据转移支持

**改进**：
- 调试面板重构为三标签页设计
- 自动捕获所有控制台日志
- 日志按时间倒序显示
- 导出文件名包含工程名称

**修复**：
- 新建案卷按钮事件绑定问题
- 标签页切换逻辑优化

---

## 需要帮助？

如果遇到问题：

1. **查看调试日志**：调试面板 → 日志标签页
2. **检查系统状态**：调试面板 → 状态标签页
3. **查看浏览器控制台**：按F12 → Console标签

将相关日志和错误信息提供给开发人员以获得帮助。
