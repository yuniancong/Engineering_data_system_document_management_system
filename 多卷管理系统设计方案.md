# 多卷管理系统设计方案

## 一、需求分析

### 当前问题
1. ✅ **卷内目录导出正常** - 使用表格模板填充
2. ❌ **备考表导出为空** - 模板中缺少占位符
3. ❌ **封面导出为空** - 模板中缺少占位符
4. ❌ **只支持单卷** - 实际工程需要多个卷
5. ❌ **缺少移交书页面** - 需要汇总所有资料

### 用户需求
1. **多卷管理**：一个工程包含多个案卷
2. **案卷独立管理**：每个案卷有自己的卷内目录、备考表、封面
3. **汇总功能**：
   - 案卷目录（汇总所有卷的概要信息）
   - 档案移交书（汇总所有资料的说明）
4. **工作流程**：
   ```
   新建工程 → 新建案卷1 → 填写卷内目录 → 生成备考表/封面
            → 新建案卷2 → 填写卷内目录 → 生成备考表/封面
            → ...
            → 生成案卷目录（汇总）
            → 生成移交书（汇总）
   ```

## 二、系统架构设计

### 数据结构设计

```javascript
// 工程数据结构
{
    projectInfo: {
        id: '工程ID',
        name: '工程名称',
        unit: '编制单位',
        createDate: '创建日期',
        secretLevel: '密级',
        retentionPeriod: '保管期限'
    },

    // 案卷列表
    volumes: [
        {
            id: '卷ID',
            volumeNo: 1,  // 案卷号
            title: '案卷题名',
            archiveNo: '档号',
            startDate: '起始日期',
            endDate: '结束日期',

            // 卷内目录（原directoryData）
            directory: [
                {
                    serial: 1,
                    fileNumber: '文件编号',
                    responsible: '责任者',
                    title: '文件题名',
                    date: '日期',
                    pages: '页次',
                    remark: '备注'
                }
            ],

            // 卷内备考表（原recordData）
            record: {
                totalPages: 0,
                textPages: 0,
                drawingPages: 0,
                photoCount: 0,
                note: '',
                creator: '',
                createDate: '',
                reviewer: '',
                reviewDate: ''
            },

            // 封面数据（原coverData的一部分）
            cover: {
                archiveNo: '',
                title: '',
                unit: '',
                startDate: '',
                endDate: '',
                secretLevel: '',
                retentionPeriod: '',
                volumeNumber: 1,
                totalVolumes: 0
            }
        }
    ],

    // 案卷目录（汇总）- 原catalogData
    catalog: [
        {
            volumeNo: 1,
            title: '案卷题名',
            textPages: 0,
            drawingPages: 0,
            other: '',
            unit: '',
            createDate: '',
            retentionPeriod: ''
        }
    ],

    // 档案移交书
    transfer: {
        unit: '移交单位',
        transferDate: '移交日期',
        totalVolumes: 0,
        totalPages: 0,
        note: '移交说明',
        transferPerson: '移交人',
        receivePerson: '接收人'
    }
}
```

### UI结构设计

```
主界面
├── 工程管理
│   ├── 新建工程
│   ├── 加载工程
│   └── 工程信息
│
├── 案卷管理（新增）
│   ├── 案卷列表
│   ├── 新建案卷
│   ├── 切换案卷
│   └── 删除案卷
│
├── 当前案卷编辑
│   ├── 卷内目录（原有）
│   ├── 卷内备考表（原有）
│   └── 案卷封面（原有）
│
├── 汇总管理（新增）
│   ├── 案卷目录（汇总所有卷）
│   └── 档案移交书（专门页面）
│
└── 导出功能
    ├── 导出当前案卷
    │   ├── 卷内目录
    │   ├── 备考表
    │   └── 封面
    ├── 导出汇总文档
    │   ├── 案卷目录
    │   └── 档案移交书
    └── 导出全部文档
```

## 三、实施计划

### 阶段一：修复当前导出问题（立即）

#### 1. 添加调试工具 ✅
- 创建 `debug-helper.js`
- 在页面右下角显示调试按钮
- 提供数据检查、模板验证、快速操作

#### 2. 模板占位符说明
- 更新 `templates/模板占位符说明.md`
- 提供具体的占位符示例
- 说明如何在Word中添加占位符

#### 3. 用户操作指南
```
步骤1：点击"自动生成其他表格"按钮
步骤2：编辑模板文件（添加占位符）
  - 打开 templates/表四、卷内备考表.docx
  - 添加：本案卷共有文件材料 {{totalPages}} 页
  - 保存
步骤3：重新导出Word文档
```

### 阶段二：重构为多卷管理系统（1-2天）

#### 1. 数据层重构
- 修改 `data-manager.js`
- 实现多卷数据结构
- 添加卷管理方法：
  - `createVolume()` - 新建案卷
  - `switchVolume(id)` - 切换案卷
  - `deleteVolume(id)` - 删除案卷
  - `generateCatalog()` - 生成案卷目录
  - `generateTransfer()` - 生成移交书

#### 2. UI层重构
- 添加案卷管理界面
- 添加移交书专门页面
- 修改标签页结构：
  ```
  [工程信息] [案卷管理] [卷内目录] [备考表] [封面] [案卷目录] [移交书] [数据操作]
  ```

#### 3. 导出功能升级
- 支持导出指定案卷的文档
- 支持导出汇总文档（案卷目录、移交书）
- 支持导出全部案卷文档

### 阶段三：增强功能（2-3天）

#### 1. 移交书专门页面
- 独立的表单界面
- 自动汇总统计：
  - 总案卷数
  - 总文件数
  - 总页数
  - 各类材料统计
- 可编辑的移交说明
- 移交人/接收人信息

#### 2. 工程管理功能
- 新建工程
- 保存/加载工程
- 工程信息编辑
- 多工程切换

#### 3. 数据导入导出
- 导出整个工程为JSON
- 导入工程JSON
- 批量导出所有案卷Word文档

## 四、技术方案

### 1. 向后兼容
保留原有数据格式支持，自动迁移：
```javascript
// 检测旧数据格式
if (oldData.directoryData && !oldData.volumes) {
    // 自动转换为新格式
    newData.volumes = [{
        id: generateId(),
        volumeNo: 1,
        directory: oldData.directoryData,
        record: oldData.recordData,
        cover: oldData.coverData
    }];
}
```

### 2. 数据持久化
```javascript
// LocalStorage 结构
localStorage.setItem('currentProject', JSON.stringify(projectData));
localStorage.setItem('currentVolumeId', volumeId);
localStorage.setItem('projectList', JSON.stringify(projectList));
```

### 3. 文件命名规范
```
导出文件名：
- 卷内目录_卷1_2024-11-16.docx
- 卷内备考表_卷1_2024-11-16.docx
- 案卷封面_卷1_2024-11-16.docx
- 案卷目录_2024-11-16.docx
- 档案移交书_2024-11-16.docx
```

## 五、UI原型

### 案卷管理界面
```
╔═══════════════════════════════════════════════╗
║  案卷管理                                      ║
╠═══════════════════════════════════════════════╣
║  当前工程：某某工程项目                         ║
║  工程单位：某某建设单位                         ║
║  ─────────────────────────────────────────    ║
║  案卷列表：                                    ║
║  ┌─────────────────────────────────────┐    ║
║  │ [1] 设计文件卷            [查看][编辑][删除]│    ║
║  │ [2] 施工文件卷            [查看][编辑][删除]│    ║
║  │ [3] 竣工文件卷            [查看][编辑][删除]│    ║
║  └─────────────────────────────────────┘    ║
║  ─────────────────────────────────────────    ║
║  [+ 新建案卷]  [生成案卷目录]  [生成移交书]      ║
╚═══════════════════════════════════════════════╝
```

### 移交书界面
```
╔═══════════════════════════════════════════════╗
║  档案移交书                                    ║
╠═══════════════════════════════════════════════╣
║  工程名称：[                    ]              ║
║  移交单位：[                    ]              ║
║  移交日期：[2024-11-16         ]              ║
║  ─────────────────────────────────────────    ║
║  汇总统计：                                    ║
║  • 案卷数量：3 卷                              ║
║  • 文件总数：150 份                            ║
║  • 文件总页数：1500 页                         ║
║    - 文字材料：1200 页                         ║
║    - 图样材料：280 页                          ║
║    - 照片：20 张                               ║
║  ─────────────────────────────────────────    ║
║  移交说明：                                    ║
║  [本工程档案资料已按GB 50328-2014标准整理完毕   ║
║   现移交存档。                               ]║
║  ─────────────────────────────────────────    ║
║  移交人：[          ]  日期：[            ]    ║
║  接收人：[          ]  日期：[            ]    ║
║  ─────────────────────────────────────────    ║
║  [保存]  [导出Word]                           ║
╚═══════════════════════════════════════════════╝
```

## 六、开发优先级

### P0（立即解决）
1. ✅ 添加调试工具
2. ⚠️ 模板占位符添加指导
3. ⚠️ 用户快速修复指南

### P1（核心功能 - 1周内）
1. 多卷数据结构实现
2. 案卷管理界面
3. 移交书专门页面
4. 导出功能升级

### P2（增强功能 - 2周内）
1. 工程管理功能
2. 数据导入导出
3. 批量操作

## 七、用户迁移指南

### 现有用户
1. 数据会自动转换为单卷工程
2. 可以继续使用原有功能
3. 需要时可添加更多案卷

### 新用户
1. 创建工程
2. 添加案卷
3. 填写数据
4. 生成汇总
5. 导出文档

## 八、风险评估

### 技术风险
- ⚠️ 数据迁移兼容性 → 方案：充分测试旧数据转换
- ⚠️ UI重构影响 → 方案：保留原有操作逻辑
- ⚠️ 性能问题 → 方案：延迟加载、分页显示

### 用户风险
- ⚠️ 学习成本 → 方案：详细文档、操作向导
- ⚠️ 数据丢失 → 方案：自动备份、版本控制

## 九、下一步行动

### 立即执行（您现在可以做的）
1. 打开网页，点击右下角"🔍 调试"按钮
2. 查看数据状态
3. 点击"⚡ 自动生成所有数据"
4. 按照提示编辑模板文件添加占位符
5. 重新导出Word文档

### 开发团队执行
1. 实施阶段一：修复当前问题
2. 设计评审：讨论数据结构和UI设计
3. 实施阶段二：重构多卷管理
4. 测试验证：完整功能测试
5. 用户培训：提供使用文档

---

**注意：** 本设计方案已考虑向后兼容性，现有数据不会丢失。建议先修复当前导出问题，然后逐步实施多卷管理功能。
