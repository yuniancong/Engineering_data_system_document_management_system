# 多卷管理系统使用指南

## 系统概述

已成功实现完整的多卷管理系统，现在支持：
- 一个工程包含多个案卷
- 每个案卷独立管理卷内目录、备考表、封面
- 自动生成汇总数据（案卷目录、档案移交书）
- 完整的Word文档导出功能

---

## 快速开始

### 1. 启动系统

```bash
./run.sh
```

系统会自动：
- 检测并激活虚拟环境（myenv/venv/.venv）
- 查找可用端口（8000-8009）
- 启动HTTP服务器
- 打开浏览器

### 2. 首次使用流程

#### 步骤1：填写工程信息
在"案卷管理"标签页：
- 输入工程名称
- 输入编制单位
- 选择密级（无/秘密/机密/绝密）
- 选择保管期限（永久/长期/短期）

系统会自动保存您的输入。

#### 步骤2：新建案卷
1. 点击"+ 新建案卷"按钮
2. 输入案卷题名（如：设计文件卷、施工文件卷）
3. 点击"创建"

系统会自动：
- 为案卷分配编号
- 创建独立的数据结构
- 切换到新建的案卷

#### 步骤3：填写卷内目录
1. 切换到"卷内目录"标签页
2. 点击"添加行"添加文件条目
3. 填写文件信息：
   - 文件编号
   - 责任者
   - 文件题名
   - 日期
   - 页次
   - 备注

**提示**：支持以下快捷功能：
- 粘贴整行：从Excel直接粘贴多行数据
- 自定义粘贴：自由映射Excel列到系统字段
- 列粘贴模式：逐列粘贴数据

#### 步骤4：生成其他表格
1. 点击"自动生成其他表格"按钮
2. 系统会自动：
   - 统计总页数、文字页数、图样页数、照片数
   - 生成卷内备考表数据
   - 生成案卷封面数据

#### 步骤5：补充其他信息

**卷内备考表**：
- 查看自动生成的统计数据
- 填写说明
- 填写立卷人、审核人及日期

**案卷封面**：
- 查看自动生成的基本信息
- 补充档号
- 确认起止日期

---

## 多卷管理功能

### 案卷列表

在"案卷管理"页面，您可以看到所有案卷：

```
┌─────────────────────────────────────┐
│ 案卷1：设计文件卷          [✓ 当前]  │
│ 文件数：25份  总页数：320页  照片：5张│
├─────────────────────────────────────┤
│ 案卷2：施工文件卷            [切换]   │
│ 文件数：30份  总页数：450页  照片：8张│
└─────────────────────────────────────┘
```

### 案卷操作

**切换案卷**：
- 点击"切换"按钮
- 系统会自动加载该案卷的所有数据
- 自动跳转到"卷内目录"标签页

**编辑案卷**：
- 点击"编辑"按钮
- 修改案卷题名

**删除案卷**：
- 点击"删除"按钮
- 确认删除（至少保留一个案卷）

### 生成汇总数据

点击"生成汇总数据"按钮，系统会：
1. 为所有案卷生成备考表
2. 为所有案卷生成封面
3. 生成案卷目录（汇总所有案卷概要）
4. 更新移交书统计数据

---

## 档案移交书功能

### 自动统计

在"档案移交书"标签页，系统会自动计算：

**基本统计**：
- 案卷数量：共多少卷
- 文件总数：所有案卷的文件总数
- 文件总页数：所有案卷的页数总和

**材料分类统计**：
- 文字材料：X卷 / Y页
- 图样材料：X卷 / Y张
- 照片：X张

**统计规则**：
- **文字材料卷**：文字页数 > 图样页数的案卷
- **图样材料卷**：图样页数 > 文字页数的案卷
- 系统自动判断案卷类型

### 移交信息

需要手动填写：
- 移交说明（默认已提供标准文本）
- 移交人
- 移交日期
- 接收人
- 接收日期

### 刷新统计

如果修改了案卷数据：
1. 点击"刷新统计数据"按钮
2. 系统会重新计算所有统计数据

---

## Word文档导出

### 导出单个文档

点击"导出Word"按钮，选择要导出的类型：

1. **📄 卷内目录**
   - 导出当前案卷的卷内目录
   - 使用表格模板自动填充

2. **📋 卷内备考表**
   - 导出当前案卷的备考表
   - 使用占位符模板填充

3. **📕 案卷封面**
   - 导出当前案卷的封面
   - 使用占位符模板填充

4. **📚 案卷目录**
   - 导出所有案卷的汇总目录
   - 使用表格模板自动填充

5. **📮 档案移交书**
   - 导出移交书
   - 包含所有统计数据和移交信息

### 导出全部文档

选择"📦 导出全部文档"，系统会依次导出：
- 当前案卷的卷内目录
- 当前案卷的备考表
- 当前案卷的封面
- 案卷目录
- 档案移交书

---

## 模板占位符说明

### 卷内备考表（表四）

已支持的占位符：
- `{{totalPages}}` - 总页数
- `{{textPages}}` - 文字材料页数
- `{{drawingPages}}` - 图样材料页数
- `{{photoCount}}` - 照片张数
- `{{note}}` - 说明
- `{{creator}}` - 立卷人
- `{{createDate}}` - 立卷日期
- `{{reviewer}}` - 审核人
- `{{reviewDate}}` - 审核日期

### 案卷封面（表二）

已支持的占位符：
- `{{archiveNo}}` - 档号
- `{{title}}` - 案卷题名
- `{{unit}}` - 编制单位
- `{{startDate}}` - 起始日期
- `{{endDate}}` - 结束日期
- `{{secretLevel}}` - 密级
- `{{retentionPeriod}}` - 保管期限
- `{{totalVolumes}}` - 本工程共几卷
- `{{volumeNumber}}` - 本案卷为第几卷

### 档案移交书（附件3）

**基本信息**（手动填写）：
- `{{title}}` - 工程名称
- `{{unit}}` - 移交单位
- `{{date}}` - 移交日期
- `{{archiveNo}}` - 档号
- `{{secretLevel}}` - 密级
- `{{retentionPeriod}}` - 保管期限

**统计数据**（自动计算）：
- `{{totalVolumes}}` - 案卷数量
- `{{totalFiles}}` - 文件总数
- `{{totalPages}}` - 文件总页数
- `{{textPages}}` - 文字材料总页数
- `{{drawingPages}}` - 图样材料总页数
- `{{photoCount}}` - 照片总数
- `{{textVolumes}}` - 文字材料卷数
- `{{drawingVolumes}}` - 图样材料卷数
- `{{otherVolumes}}` - 其他材料卷数

**移交信息**（手动填写）：
- `{{note}}` - 移交说明
- `{{transferPerson}}` - 移交人
- `{{transferDate}}` - 移交日期
- `{{receivePerson}}` - 接收人
- `{{receiveDate}}` - 接收日期

---

## 调试工具

### 打开调试面板

点击页面右下角的"🔍 调试"按钮。

### 功能说明

**📊 数据状态**：
- 查看当前所有数据
- 检查哪些字段缺失

**📄 模板状态**：
- 查看模板配置指南
- 测试导出功能

**🔧 快速操作**：
- ⚡ 自动生成所有数据：一键生成备考表、封面、案卷目录数据
- 💾 导出数据JSON：备份当前所有数据
- 🗄️ 查看存储数据：查看LocalStorage中的数据
- 🧪 测试导出功能：检查数据完整性

---

## 数据存储

### 自动保存

系统会在以下情况自动保存数据：
- 修改工程信息
- 创建/删除/切换案卷
- 修改卷内目录
- 修改备考表/封面
- 修改移交信息

### 手动保存

点击页面底部的"保存数据"按钮手动保存。

### 数据导出

**导出Excel**：
- 导出当前案卷的卷内目录为Excel
- 方便数据备份和共享

**导出JSON**：
- 使用调试工具导出完整的项目数据
- 包含所有案卷的所有数据

### 数据加载

点击"加载数据"按钮，从之前保存的数据恢复。

---

## 常见问题

### Q1: 如何切换到另一个案卷？

**方法1**：在"案卷管理"页面
1. 找到要切换的案卷
2. 点击"切换"按钮

**方法2**：使用案卷列表
1. 案卷列表显示"✓ 当前"的是当前案卷
2. 点击其他案卷的"切换"按钮

### Q2: 删除案卷后数据会丢失吗？

是的，删除操作会永久删除该案卷的所有数据，包括：
- 卷内目录
- 备考表
- 封面

**建议**：删除前先导出Word文档或Excel数据备份。

### Q3: 如何为所有案卷批量生成数据？

在"案卷管理"页面点击"生成汇总数据"按钮，系统会：
1. 为每个案卷生成备考表
2. 为每个案卷生成封面
3. 生成案卷目录
4. 更新移交书统计

### Q4: 移交书的统计数据不准确怎么办？

1. 确认所有案卷的卷内目录数据已填写
2. 点击"自动生成其他表格"生成备考表
3. 切换到"档案移交书"标签页
4. 点击"刷新统计数据"按钮

### Q5: 导出的Word文档为空怎么办？

参考《立即修复导出问题指南.md》：
1. 确认模板文件中包含占位符
2. 使用调试工具检查数据状态
3. 点击"自动生成所有数据"

### Q6: 如何理解材料分类统计？

**文字材料卷**：
- 如果案卷中文字页数 > 图样页数
- 则该案卷被归类为"文字材料卷"

**图样材料卷**：
- 如果案卷中图样页数 > 文字页数
- 则该案卷被归类为"图样材料卷"

**其他材料卷**：
- 目前预留字段，暂未使用

### Q7: 旧数据会丢失吗？

不会！系统会自动迁移旧数据：
- 自动检测旧的单卷数据
- 转换为多卷结构
- 创建一个默认案卷
- 将旧数据迁移到默认案卷

---

## 完整工作流程示例

### 场景：某建设工程有3个案卷

#### 步骤1：初始化工程
```
案卷管理 → 填写工程信息
- 工程名称：某某住宅小区建设工程
- 编制单位：某某建设公司
- 密级：无
- 保管期限：永久
```

#### 步骤2：创建案卷
```
新建案卷1：设计文件卷
新建案卷2：施工文件卷
新建案卷3：竣工文件卷
```

#### 步骤3：填写第1卷数据
```
切换到"设计文件卷" → 卷内目录 → 添加数据
- 添加20条设计文件记录
- 点击"自动生成其他表格"
- 补充备考表的立卷人、审核人
- 补充封面的档号
```

#### 步骤4：填写第2卷数据
```
切换到"施工文件卷" → 卷内目录 → 添加数据
- 添加30条施工文件记录
- 点击"自动生成其他表格"
- 补充备考表的立卷人、审核人
- 补充封面的档号
```

#### 步骤5：填写第3卷数据
```
切换到"竣工文件卷" → 卷内目录 → 添加数据
- 添加15条竣工文件记录
- 点击"自动生成其他表格"
- 补充备考表的立卷人、审核人
- 补充封面的档号
```

#### 步骤6：生成汇总
```
案卷管理 → 生成汇总数据
结果：
- 案卷目录：包含3个案卷的概要信息
- 移交书统计：
  - 案卷数量：3卷
  - 文件总数：65份
  - 文件总页数：自动计算
  - 材料分类：自动统计
```

#### 步骤7：填写移交信息
```
档案移交书 → 移交信息
- 移交说明：（默认已填写）
- 移交人：张三
- 移交日期：2024-11-16
- 接收人：李四
- 接收日期：2024-11-17
```

#### 步骤8：导出文档
```
导出Word → 选择"导出全部文档"
获得文件：
- 卷内目录_2024-11-16.docx（当前卷）
- 卷内备考表_2024-11-16.docx（当前卷）
- 案卷封面_2024-11-16.docx（当前卷）
- 档案移交目录_2024-11-16.docx（汇总）
- 档案移交书_2024-11-16.docx（汇总）
```

---

## 技术说明

### 系统架构

```
┌─────────────────────────────────────────┐
│           用户界面 (index.html)          │
├─────────────────────────────────────────┤
│  volume-ui.js    │    app.js             │
│  (多卷UI逻辑)     │    (原有UI逻辑)       │
├──────────────────┼───────────────────────┤
│ volume-manager.js│   data-manager.js     │
│ (多卷数据管理)    │   (单卷数据管理)       │
├──────────────────┴───────────────────────┤
│         word-exporter.js                 │
│         (Word文档导出)                    │
├─────────────────────────────────────────┤
│         LocalStorage                     │
│         (浏览器本地存储)                   │
└─────────────────────────────────────────┘
```

### 数据结构

```javascript
{
  projectInfo: {
    id: '工程ID',
    name: '工程名称',
    unit: '编制单位',
    secretLevel: '密级',
    retentionPeriod: '保管期限'
  },

  volumes: [
    {
      id: '案卷ID',
      volumeNo: 1,
      title: '案卷题名',
      directory: [...],    // 卷内目录
      record: {...},       // 备考表
      cover: {...}         // 封面
    }
  ],

  transferData: {
    note: '移交说明',
    transferPerson: '移交人',
    transferDate: '移交日期',
    receivePerson: '接收人',
    receiveDate: '接收日期'
  }
}
```

### 向后兼容

系统自动检测并迁移旧数据：
1. 检测LocalStorage中的旧数据格式
2. 创建默认案卷
3. 将旧数据迁移到默认案卷
4. 保留所有原有数据

---

## 相关文档

- **立即修复导出问题指南.md** - 快速解决导出问题
- **多卷管理系统设计方案.md** - 完整的系统设计文档
- **档案移交书占位符说明.md** - 移交书占位符详细说明
- **README.md** - 项目总体说明

---

## 获取帮助

如果遇到问题：
1. 查看"调试面板"检查数据状态
2. 参考《立即修复导出问题指南.md》
3. 查看浏览器控制台（F12）的错误信息

---

**版本**：v2.0 - 多卷管理系统
**更新日期**：2024-11-16
**符合标准**：GB 50328-2014《建设工程文件归档规范》
